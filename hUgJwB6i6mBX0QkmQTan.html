<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #002f34;
            --secondary-color: #23e5db;
            --accent-color: #ffce32;
            --light-color: #f2f4f5;
            --dark-color: #002f34;
            --success-color: #00a650;
            --warning-color: #ff6b6b;
            --bg-color: #f2f4f5;
            --text-color: #002f34;
            --card-bg: white;
            --input-bg: white;
        }
        
        /* Dark mode variables */
        .dark-mode {
            --primary-color: #23e5db;
            --secondary-color: #002f34;
            --accent-color: #ffce32;
            --light-color: #121212;
            --dark-color: #f2f4f5;
            --bg-color: #121212;
            --text-color: #f2f4f5;
            --card-bg: #1e1e1e;
            --input-bg: #2d2d2d;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
            padding-bottom: 60px;
            margin: 0;
        }

        /* Loading screen styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
        }

        .loading-logo i {
            margin-right: 10px;
        }

        .loading-dots {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .loading-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--primary-color);
            animation: loadingPulse 1.5s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes loadingPulse {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Shop header */
        .shop-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            position: relative;
            transition: all 0.3s ease;
        }

        .shop-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
            transition: all 0.3s ease;
        }

        .shop-description {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0;
            transition: all 0.3s ease;
        }

        /* Product cards */
        .product-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-bottom: 20px;
            overflow: hidden;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .product-img-container {
            height: 200px;
            overflow: hidden;
            position: relative;
            background-color: #f8f9fa;
        }

        .product-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .product-card:hover .product-img {
            transform: scale(1.05);
        }

        .product-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--accent-color);
            color: var(--dark-color);
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .product-price {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .product-old-price {
            text-decoration: line-through;
            opacity: 0.6;
            font-size: 0.9rem;
        }

        .product-discount {
            color: var(--success-color);
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Product details modal */
        .product-modal-img {
            max-height: 300px;
            object-fit: contain;
            width: 100%;
            border-radius: 8px;
        }

        .product-gallery {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .product-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .product-thumbnail.active {
            border-color: var(--primary-color);
        }

        .option-selector {
            margin-bottom: 15px;
        }

        .option-label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .option-values {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .option-value {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-value.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Cart sidebar */
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background-color: var(--card-bg);
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1050;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .cart-sidebar.open {
            right: 0;
        }

        .cart-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1040;
            display: none;
        }

        .cart-backdrop.open {
            display: block;
        }

        .cart-item-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .cart-item-options {
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            background-color: transparent;
            cursor: pointer;
        }

        .quantity-input {
            width: 40px;
            height: 30px;
            text-align: center;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            border-left: none;
            border-right: none;
        }

        /* Bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 10px 0;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-color);
            font-size: 0.8rem;
        }

        .bottom-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        .bottom-nav-item.active {
            color: var(--primary-color);
        }

        .cart-btn {
            position: relative;
        }

        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--warning-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Search container */
        .search-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
        }

        /* Improved search input */
        .search-input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            padding-left: 40px;
            border-radius: 20px;
            border: 1px solid #ddd;
            height: 40px;
            width: 100%;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 47, 52, 0.25);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            color: #6c757d;
        }

        /* Loading spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Product options */
        .product-options {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        /* WhatsApp button */
        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .whatsapp-btn i {
            margin-right: 5px;
        }

        .whatsapp-btn:hover {
            background-color: #128C7E;
            color: white;
        }

        /* Delivery info */
        .delivery-info {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: 8px;
        }

        /* Product grid improvements */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        /* Infinite scroll loader */
        .infinite-loader {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        /* No products message */
        .no-products {
            text-align: center;
            padding: 40px 0;
            grid-column: 1 / -1;
        }
        
        .list-group-item {
            transition: all 0.2s;
            text-align: left;
        }

        .list-group-item:hover {
            background-color: var(--light-color);
        }

        .list-group-item h6 {
            color: var(--primary-color);
        }

        .list-group-item small {
            color: var(--text-color);
            opacity: 0.8;
        }

        /* Shop logo styles */
        .shop-logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin-right: 15px;
        }

        /* Header content */
        .header-content {
            display: flex;
            align-items: center;
        }

        /* Closed shop message */
        .shop-closed {
            text-align: center;
            padding: 50px 20px;
        }

        .shop-closed-icon {
            font-size: 3rem;
            color: var(--warning-color);
            margin-bottom: 20px;
        }

        /* Responsive adjustments */
        @media (min-width: 576px) {
            .product-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 768px) {
            .product-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .shop-title {
                font-size: 1.2rem;
            }
            
            .product-img-container {
                height: 150px;
            }
            
            .cart-sidebar {
                width: 100%;
                right: -100%;
            }
            
            .cart-sidebar.open {
                right: 0;
            }
        }

        @media (min-width: 992px) {
            .product-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-up {
            animation: slideUp 0.3s ease-in-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Skeleton loading */
        .skeleton {
            background-color: #e0e0e0;
            border-radius: 4px;
            animation: skeleton-loading 1.5s infinite ease-in-out;
        }

        .skeleton-img {
            width: 100%;
            height: 150px;
            margin-bottom: 10px;
        }

        .skeleton-text {
            height: 12px;
            margin-bottom: 8px;
        }

        .skeleton-text-sm {
            height: 10px;
            width: 50%;
        }

        @keyframes skeleton-loading {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <i class="fas fa-store"></i>
            <span>Loading Shop...</span>
        </div>
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
    </div>

    <!-- Shop Header -->
    <div class="shop-header" id="shopHeader">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="header-content">
                        <img src="" class="shop-logo" id="shopLogo" style="display: none;">
                        <div>
                            <h1 class="shop-title" id="shopTitle">Shop Name</h1>
                            <p class="shop-description" id="shopDescription">Shop description goes here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4 mb-5">
        <!-- Search and Filter -->
        <div class="search-container">
            <div class="row g-2 align-items-center">
                <div class="col-md-12">
                    <div class="search-input-group">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="form-control search-input" id="searchInput" placeholder="Search products...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Closed Shop Message -->
        <div class="shop-closed" id="shopClosed" style="display: none;">
            <div class="shop-closed-icon">
                <i class="fas fa-store-slash"></i>
            </div>
            <h3>Shop Closed</h3>
            <p>This shop is currently not available</p>
            <a href="vav2.html" class="btn btn-primary mt-3">
                <i class="fas fa-arrow-left me-2"></i> Back to Shops
            </a>
        </div>

        <!-- Products Grid -->
        <div class="product-grid" id="productsGrid">
            <!-- Skeleton loading -->
            <div class="product-card">
                <div class="product-img-container skeleton skeleton-img"></div>
                <div class="p-3">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
            <div class="product-card">
                <div class="product-img-container skeleton skeleton-img"></div>
                <div class="p-3">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
            <div class="product-card">
                <div class="product-img-container skeleton skeleton-img"></div>
                <div class="p-3">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
            <div class="product-card">
                <div class="product-img-container skeleton skeleton-img"></div>
                <div class="p-3">
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Infinite Scroll Loader -->
        <div class="infinite-loader" id="infiniteLoader" style="display: none;">
            <div class="spinner"></div>
        </div>

        <!-- No Products Message -->
        <div class="no-products" id="noProducts" style="display: none;">
            <i class="fas fa-box-open fa-3x mb-3" style="opacity: 0.3;"></i>
            <h5>No products found</h5>
            <p>This shop doesn't have any products yet</p>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Product Name</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <img src="" class="product-modal-img" id="productModalImage">
                            <div class="product-gallery" id="productGallery">
                                <!-- Thumbnails will be added here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4 id="productModalName">Product Name</h4>
                            <div class="mb-3">
                                <span class="product-price" id="productModalPrice">$0.00</span>
                                <span class="product-old-price ms-2" id="productModalOldPrice"></span>
                                <span class="product-discount ms-2" id="productModalDiscount"></span>
                            </div>
                            <p id="productModalDescription">Product description goes here</p>
                            
                            <div class="product-options" id="productOptions">
                                <!-- Product options will be added here -->
                            </div>
                            
                            <div class="delivery-info" id="deliveryInfo" style="display: none;">
                                <h6><i class="fas fa-truck me-2"></i>Delivery Information</h6>
                                <p id="deliveryDetails"></p>
                                <p id="deliveryPrice" style="display: none;">
                                    <i class="fas fa-money-bill-wave me-2"></i> Delivery Price: <span id="deliveryPriceValue"></span>
                                </p>
                                <p id="deliveryTime" style="display: none;">
                                    <i class="fas fa-clock me-2"></i> Delivery Time: <span id="deliveryTimeValue"></span>
                                </p>
                                <p id="deliveryFromTo" style="display: none;">
                                    <i class="fas fa-map-marker-alt me-2"></i> From <span id="deliveryFrom"></span> to <span id="deliveryTo"></span>
                                </p>
                                <p id="shopPhone" style="display: none;">
                                    <i class="fas fa-phone me-2"></i> Shop Owner: <span id="shopPhoneNumber"></span>
                                </p>
                                <p id="deliveryPhone" style="display: none;">
                                    <i class="fas fa-truck me-2"></i> Delivery Contact: <span id="deliveryPhoneNumber"></span>
                                </p>
                            </div>
                            
                            <div class="mt-4">
                                <button class="btn btn-primary me-2" id="addToCartBtn">
                                    <i class="fas fa-cart-plus me-1"></i> Add to Cart
                                </button>
                                <a href="#" class="whatsapp-btn" id="whatsappBtn" target="_blank" style="display: none;">
                                    <i class="fab fa-whatsapp me-1"></i> Contact Shop
                                </a>
                                <a href="#" class="whatsapp-btn" id="whatsappDeliveryBtn" target="_blank" style="display: none; background-color: #34B7F1;">
                                    <i class="fas fa-truck me-1"></i> Contact Delivery
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Sidebar -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-shopping-cart me-2"></i>Your Cart</h5>
                <button class="btn-close" id="closeCartBtn"></button>
            </div>
            
            <div class="cart-items" id="cartItems">
                <!-- Cart items will be added here -->
                <div class="text-center py-4">
                    <i class="fas fa-shopping-cart fa-2x mb-2" style="opacity: 0.3;"></i>
                    <p>Your cart is empty</p>
                </div>
            </div>
            
            <div class="cart-summary" id="cartSummary" style="display: none;">
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span id="cartSubtotal">$0.00</span>
                </div>
                
                <div id="cartDeliveryInfo" style="display: none;">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Delivery:</span>
                        <span id="cartDeliveryPrice">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Estimated Time:</span>
                        <span id="cartDeliveryTime"></span>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mb-3">
                    <span>Total:</span>
                    <span class="fw-bold" id="cartTotal">$0.00</span>
                </div>
                
                <div id="cartContactInfo" style="display: none;">
                    <div class="mb-3">
                        <p><i class="fas fa-phone me-2"></i> Shop Owner: <span id="cartShopPhone"></span></p>
                        <p><i class="fas fa-truck me-2"></i> Delivery Contact: <span id="cartDeliveryPhone"></span></p>
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <a href="#" class="btn btn-success flex-grow-1" id="whatsappCartBtn" target="_blank">
                        <i class="fab fa-whatsapp me-1"></i> Contact Shop
                    </a>
                    <a href="#" class="btn btn-primary flex-grow-1" id="whatsappDeliveryCartBtn" target="_blank" style="background-color: #34B7F1; border-color: #34B7F1;">
                        <i class="fas fa-truck me-1"></i> Contact Delivery
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="cart-backdrop" id="cartBackdrop"></div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="container">
            <div class="row">
                <div class="col">
                    <a href="#" class="bottom-nav-item active" id="homeNavBtn">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                </div>
                <div class="col">
                    <a href="#" class="bottom-nav-item cart-btn" id="cartNavBtn">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Cart</span>
                        <span class="cart-badge" id="cartBadge" style="display: none;">0</span>
                    </a>
                </div>
                <div class="col">
                    <a href="vav2.html" class="bottom-nav-item">
                        <i class="fas fa-store"></i>
                        <span>Shops</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCNTvC5CQm8G2Fv_P0JQo2EYFUzEQ4PXjY",
            authDomain: "shop-page-944e3.firebaseapp.com",
            projectId: "shop-page-944e3",
            storageBucket: "shop-page-944e3.appspot.com",
            messagingSenderId: "866892987978",
            appId: "1:866892987978:web:be89a1dd010b9ee84730b3",
            measurementId: "G-3SB9910184"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const database = firebase.database();

        // Enable offline persistence
        db.enablePersistence()
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log("Offline persistence can only be enabled in one tab at a time.");
                } else if (err.code == 'unimplemented') {
                    console.log("The current browser does not support offline persistence.");
                }
            });

        // DOM elements
        const IMGBB_API_KEY = '522870512c188ddca7e0bcd4d64618e0';
        const loadingScreen = document.getElementById('loadingScreen');
        const shopHeader = document.getElementById('shopHeader');
        const shopTitle = document.getElementById('shopTitle');
        const shopDescription = document.getElementById('shopDescription');
        const shopLogo = document.getElementById('shopLogo');
        const productsGrid = document.getElementById('productsGrid');
        const noProducts = document.getElementById('noProducts');
        const shopClosed = document.getElementById('shopClosed');
        const searchInput = document.getElementById('searchInput');
        const productModal = new bootstrap.Modal(document.getElementById('productModal'));
        const productModalTitle = document.getElementById('productModalTitle');
        const productModalImage = document.getElementById('productModalImage');
        const productModalName = document.getElementById('productModalName');
        const productModalPrice = document.getElementById('productModalPrice');
        const productModalOldPrice = document.getElementById('productModalOldPrice');
        const productModalDiscount = document.getElementById('productModalDiscount');
        const productModalDescription = document.getElementById('productModalDescription');
        const productGallery = document.getElementById('productGallery');
        const productOptions = document.getElementById('productOptions');
        const addToCartBtn = document.getElementById('addToCartBtn');
        const whatsappBtn = document.getElementById('whatsappBtn');
        const whatsappDeliveryBtn = document.getElementById('whatsappDeliveryBtn');
        const deliveryInfo = document.getElementById('deliveryInfo');
        const deliveryDetails = document.getElementById('deliveryDetails');
        const deliveryPrice = document.getElementById('deliveryPrice');
        const deliveryPriceValue = document.getElementById('deliveryPriceValue');
        const deliveryTime = document.getElementById('deliveryTime');
        const deliveryTimeValue = document.getElementById('deliveryTimeValue');
        const deliveryFromTo = document.getElementById('deliveryFromTo');
        const deliveryFrom = document.getElementById('deliveryFrom');
        const deliveryTo = document.getElementById('deliveryTo');
        const shopPhone = document.getElementById('shopPhone');
        const shopPhoneNumber = document.getElementById('shopPhoneNumber');
        const deliveryPhone = document.getElementById('deliveryPhone');
        const deliveryPhoneNumber = document.getElementById('deliveryPhoneNumber');
        const cartSidebar = document.getElementById('cartSidebar');
        const cartBackdrop = document.getElementById('cartBackdrop');
        const closeCartBtn = document.getElementById('closeCartBtn');
        const cartItems = document.getElementById('cartItems');
        const cartSummary = document.getElementById('cartSummary');
        const cartSubtotal = document.getElementById('cartSubtotal');
        const cartDeliveryInfo = document.getElementById('cartDeliveryInfo');
        const cartDeliveryPrice = document.getElementById('cartDeliveryPrice');
        const cartDeliveryTime = document.getElementById('cartDeliveryTime');
        const cartTotal = document.getElementById('cartTotal');
        const cartContactInfo = document.getElementById('cartContactInfo');
        const cartShopPhone = document.getElementById('cartShopPhone');
        const cartDeliveryPhone = document.getElementById('cartDeliveryPhone');
        const whatsappCartBtn = document.getElementById('whatsappCartBtn');
        const whatsappDeliveryCartBtn = document.getElementById('whatsappDeliveryCartBtn');
        const cartBadge = document.getElementById('cartBadge');
        const cartNavBtn = document.getElementById('cartNavBtn');
        const homeNavBtn = document.getElementById('homeNavBtn');
        const infiniteLoader = document.getElementById('infiniteLoader');

        // Global variables
        let currentShopId = null;
        let currentShopData = null;
        let currentProducts = [];
        let filteredProducts = [];
        let currentCart = [];
        let selectedProduct = null;
        let selectedOptions = {};
        let lastVisibleProduct = null;
        let loadingMoreProducts = false;
        let allProductsLoaded = false;
        let searchTerm = '';

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Get shop ID from URL
            const pathParts = window.location.pathname.split('/');
            currentShopId = pathParts[pathParts.length - 1].replace('.html', '').trim();
            
            if (!currentShopId) {
                console.error('Shop ID not found in URL');
                showErrorAndReload('Shop ID not found in URL. Please check the URL and try again.');
                return;
            }
            
            // Initialize IndexedDB
            initIndexedDB();
            
            // Load shop data
            loadShopData();
            
            // Set up event listeners
            setupEventListeners();
        });

        // Initialize IndexedDB
        function initIndexedDB() {
            if (!window.indexedDB) {
                console.log("Your browser doesn't support IndexedDB");
                return;
            }
            
            const request = indexedDB.open('ShopManagementDB', 2);
            
            request.onerror = function(event) {
                console.log("Database error: ", event.target.error);
            };
            
            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                
                // Create object store for shop settings
                if (!db.objectStoreNames.contains('shopSettings')) {
                    db.createObjectStore('shopSettings', { keyPath: 'shopId' });
                }
                
                // Create object store for products
                if (!db.objectStoreNames.contains('products')) {
                    db.createObjectStore('products', { keyPath: 'id' });
                }
                
                // Create object store for carts
                if (!db.objectStoreNames.contains('carts')) {
                    db.createObjectStore('carts', { keyPath: 'shopId' });
                }
            };
            
            return request;
        }

        // Save data to IndexedDB
        function saveToIndexedDB(storeName, data) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ShopManagementDB', 2);
                
                request.onerror = function(event) {
                    reject("Database error: " + event.target.error);
                };
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    const transaction = db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    const putRequest = store.put(data);
                    
                    putRequest.onerror = function(event) {
                        reject("Error saving data: " + event.target.error);
                    };
                    
                    putRequest.onsuccess = function() {
                        resolve();
                    };
                };
            });
        }

        // Get data from IndexedDB
        function getFromIndexedDB(storeName, key) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ShopManagementDB', 2);
                
                request.onerror = function(event) {
                    reject("Database error: " + event.target.error);
                };
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    const transaction = db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    
                    const getRequest = store.get(key);
                    
                    getRequest.onerror = function(event) {
                        reject("Error getting data: " + event.target.error);
                    };
                    
                    getRequest.onsuccess = function() {
                        resolve(getRequest.result);
                    };
                };
            });
        }

        // Show error message and reload option
        function showErrorAndReload(message) {
            loadingScreen.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>
                    <h4>Error Loading Shop</h4>
                    <p class="mb-4">${message}</p>
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i class="fas fa-sync-alt me-2"></i> Reload Page
                    </button>
                </div>
            `;
        }

        // Load shop data
        function loadShopData() {
            // First try to load from IndexedDB
            getFromIndexedDB('shopSettings', currentShopId)
                .then(shopData => {
                    if (shopData) {
                        currentShopData = shopData;
                        updateShopUI();
                        
                        // Check if shop is public
                        if (!currentShopData.isPublic) {
                            showShopClosed();
                            return;
                        }
                        
                        // Load products from IndexedDB
                        loadProductsFromIndexedDB();
                    }
                    
                    // Then load from Firestore
                    db.collection('shops').doc(currentShopId).get()
                        .then(doc => {
                            if (doc.exists) {
                                currentShopData = doc.data();
                                // Ensure we have the required fields
                                if (!currentShopData.name) currentShopData.name = "Shop Name";
                                if (!currentShopData.description) currentShopData.description = "No description provided";
                                
                                // Save to IndexedDB
                                saveToIndexedDB('shopSettings', {
                                    shopId: currentShopId,
                                    ...currentShopData
                                });
                                
                                updateShopUI();
                                
                                // Check if shop is public
                                if (currentShopData.isPublic === false) {
                                    showShopClosed();
                                    return;
                                }
                                
                                loadProducts();
                                
                                setTimeout(() => {
                                    loadingScreen.classList.add('hidden');
                                }, 1000);
                            } else {
                                console.log('Shop not found');
                                // Show no shop message
                                loadingScreen.innerHTML = `
                                    <div class="text-center">
                                        <i class="fas fa-store fa-3x mb-3" style="opacity: 0.3;"></i>
                                        <h4>Shop Not Found</h4>
                                        <p class="mb-4">This shop doesn't exist or has been removed</p>
                                        <button class="btn btn-primary" onclick="window.location.href='vav2.html'">
                                            <i class="fas fa-arrow-left me-2"></i> Back to Shops
                                        </button>
                                    </div>
                                `;
                            }
                        })
                        .catch(error => {
                            console.error('Error loading shop data:', error);
                            showErrorAndReload('Error loading shop data. Please check your connection and try again.');
                        });
                })
                .catch(error => {
                    console.error('Error loading from IndexedDB:', error);
                });
        }

        // Show shop closed message
        function showShopClosed() {
            loadingScreen.classList.add('hidden');
            productsGrid.style.display = 'none';
            shopClosed.style.display = 'block';
        }

        // Update shop UI with loaded data
        function updateShopUI() {
            // Set shop title and description
            shopTitle.textContent = currentShopData.name || 'Shop Name';
            shopDescription.textContent = currentShopData.description || 'No description provided';
            
            // Set shop logo if exists
            if (currentShopData.logoUrl) {
                shopLogo.src = currentShopData.logoUrl;
                shopLogo.style.display = 'block';
            } else {
                shopLogo.style.display = 'none';
            }
            
            // Apply custom styles if they exist
            if (currentShopData.customStyles) {
                const styles = currentShopData.customStyles;
                
                // Update CSS variables
                document.documentElement.style.setProperty('--primary-color', styles.primaryColor || '#002f34');
                document.documentElement.style.setProperty('--accent-color', styles.accentColor || '#ffce32');
                
                // Update shop header
                shopHeader.style.backgroundColor = styles.primaryColor || '#002f34';
                shopTitle.style.color = styles.textColor || 'white';
                shopDescription.style.color = styles.textColor ? `rgba(${hexToRgb(styles.textColor)}, 0.8)` : 'rgba(255,255,255,0.8)';
            }
        }

        // Convert hex color to RGB
        function hexToRgb(hex) {
            // Remove # if present
            hex = hex.replace('#', '');
            
            // Parse r, g, b values
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            
            return `${r}, ${g}, ${b}`;
        }

        // Load products from IndexedDB
        function loadProductsFromIndexedDB() {
            getFromIndexedDB('products', currentShopId)
                .then(products => {
                    if (products && products.products && products.products.length > 0) {
                        currentProducts = products.products;
                        displayProducts(currentProducts);
                        noProducts.style.display = 'none';
                    } else {
                        loadProducts();
                    }
                })
                .catch(error => {
                    console.error('Error loading products from IndexedDB:', error);
                    loadProducts();
                });
        }

        // Load products with pagination (4 at a time)
        function loadProducts(loadMore = false) {
            if (loadMore && (loadingMoreProducts || allProductsLoaded)) return;
            
            if (!loadMore) {
                // Show skeleton loading
                productsGrid.innerHTML = `
                    <div class="product-card">
                        <div class="product-img-container skeleton skeleton-img"></div>
                        <div class="p-3">
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text-sm"></div>
                        </div>
                    </div>
                    <div class="product-card">
                        <div class="product-img-container skeleton skeleton-img"></div>
                        <div class="p-3">
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text-sm"></div>
                        </div>
                    </div>
                    <div class="product-card">
                        <div class="product-img-container skeleton skeleton-img"></div>
                        <div class="p-3">
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text-sm"></div>
                        </div>
                    </div>
                    <div class="product-card">
                        <div class="product-img-container skeleton skeleton-img"></div>
                        <div class="p-3">
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text-sm"></div>
                        </div>
                    </div>
                `;
                currentProducts = []; // Reset current products when loading fresh
                lastVisibleProduct = null;
                allProductsLoaded = false;
            } else {
                loadingMoreProducts = true;
                infiniteLoader.style.display = 'flex';
            }
            
            let query = db.collection('shops').doc(currentShopId)
                .collection('products')
                .where('isActive', '==', true)
                .orderBy('createdAt', 'desc')
                .limit(8); // Load 4 products initially
            
            if (loadMore && lastVisibleProduct) {
                query = query.startAfter(lastVisibleProduct);
            }
            
            query.get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        if (!loadMore) {
                            noProducts.style.display = 'block';
                            productsGrid.style.display = 'grid';
                            productsGrid.innerHTML = '';
                            loadingScreen.classList.add('hidden');
                        }
                        allProductsLoaded = true;
                        loadingMoreProducts = false;
                        infiniteLoader.style.display = 'none';
                        return;
                    }
                    
                    lastVisibleProduct = snapshot.docs[snapshot.docs.length - 1];
                    
                    const newProducts = [];
                    snapshot.forEach(doc => {
                        const product = doc.data();
                        product.id = doc.id;
                        newProducts.push(product);
                    });
                    
                    // Only add new products to avoid duplicates
                    newProducts.forEach(newProduct => {
                        if (!currentProducts.some(p => p.id === newProduct.id)) {
                            currentProducts.push(newProduct);
                        }
                    });
                    
                    // Save to IndexedDB
                    saveToIndexedDB('products', {
                        id: currentShopId,
                        products: currentProducts
                    });
                    
                    // Display products
                    displayProducts(currentProducts);
                    
                    // Show no products message if empty
                    if (currentProducts.length === 0 && !loadMore) {
                        noProducts.style.display = 'block';
                        productsGrid.style.display = 'grid';
                        productsGrid.innerHTML = '';
                    } else {
                        noProducts.style.display = 'none';
                        productsGrid.style.display = 'grid';
                    }
                    
                    loadingMoreProducts = false;
                    infiniteLoader.style.display = 'none';
                    loadingScreen.classList.add('hidden');
                })
                .catch(error => {
                    console.error('Error loading products:', error);
                    if (!loadMore) {
                        productsGrid.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>Error loading products
                            </div>
                        `;
                    }
                    loadingMoreProducts = false;
                    infiniteLoader.style.display = 'none';
                    loadingScreen.classList.add('hidden');
                });
        }

        // Display products in grid
        function displayProducts(products, append = false) {
            if (!append) {
                productsGrid.innerHTML = '';
            }
            
            // Filter out duplicates by product ID
            const uniqueProducts = [];
            const productIds = new Set();
            
            products.forEach(product => {
                if (!productIds.has(product.id)) {
                    productIds.add(product.id);
                    uniqueProducts.push(product);
                }
            });
            
            uniqueProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card fade-in';
                
                // Calculate discount if old price exists
                let discountBadge = '';
                if (product.showBadge !== false && product.oldPrice && product.oldPrice > product.price) {
                    const discount = Math.round(((product.oldPrice - product.price) / product.oldPrice) * 100);
                    discountBadge = `<div class="product-badge">${discount}% OFF</div>`;
                }
                
                // Use placeholder if no images
                const productImage = product.images && product.images.length > 0 ? 
                    product.images[0] : 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22200%22%20height%3D%22200%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_18c3b7c4b1e%20text%20%7B%20fill%3A%23AAAAAA%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_18c3b7c4b1e%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2274.0859375%22%20y%3D%22104.5%22%3E200x200%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';
                
                productCard.innerHTML = `
                    <div class="product-img-container">
                        ${discountBadge}
                        <img src="${productImage}" class="product-img" alt="${product.name}" loading="lazy">
                    </div>
                    <div class="p-3">
                        <h6>${product.name}</h6>
                        <div class="product-price">$${product.price.toFixed(2)}</div>
                        ${product.oldPrice && product.oldPrice > product.price ? 
                            `<div class="product-old-price">$${product.oldPrice.toFixed(2)}</div>` : ''}
                    </div>
                `;
                
                productCard.addEventListener('click', () => {
                    showProductDetails(product);
                });
                
                productsGrid.appendChild(productCard);
            });
        }

        // Show product details in modal
        function showProductDetails(product) {
            selectedProduct = product;
            selectedOptions = {};
            
            // Set basic product info
            productModalTitle.textContent = product.name;
            productModalName.textContent = product.name;
            productModalPrice.textContent = `$${product.price.toFixed(2)}`;
            productModalDescription.textContent = product.description || 'No description available';
            
            // Set price and discount
            if (product.oldPrice && product.oldPrice > product.price) {
                const discount = Math.round(((product.oldPrice - product.price) / product.oldPrice) * 100);
                productModalOldPrice.textContent = `$${product.oldPrice.toFixed(2)}`;
                productModalDiscount.textContent = `${discount}% OFF`;
                productModalOldPrice.style.display = 'inline';
                productModalDiscount.style.display = 'inline';
            } else {
                productModalOldPrice.style.display = 'none';
                productModalDiscount.style.display = 'none';
            }
            
            // Set product images
            productGallery.innerHTML = '';
            if (product.images && product.images.length > 0) {
                product.images.forEach((image, index) => {
                    const thumbnail = document.createElement('img');
                    thumbnail.src = image;
                    thumbnail.className = `product-thumbnail ${index === 0 ? 'active' : ''}`;
                    thumbnail.loading = 'lazy';
                    thumbnail.addEventListener('click', () => {
                        productModalImage.src = image;
                        document.querySelectorAll('.product-thumbnail').forEach(t => t.classList.remove('active'));
                        thumbnail.classList.add('active');
                    });
                    productGallery.appendChild(thumbnail);
                });
                
                // Set main image
                productModalImage.src = product.images[0];
                productModalImage.loading = 'lazy';
            } else {
                // Use placeholder if no images
                productModalImage.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22300%22%20height%3D%22300%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20300%20300%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_18c3b7c4b1e%20text%20%7B%20fill%3A%23AAAAAA%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_18c3b7c4b1e%22%3E%3Crect%20width%3D%22300%22%20height%3D%22300%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22111.0859375%22%20y%3D%22154.5%22%3E300x300%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';
            }
            
            // Set product options
            productOptions.innerHTML = '';
            if (product.options && Object.keys(product.options).length > 0) {
                Object.entries(product.options).forEach(([optionName, values]) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option-selector';
                    
                    optionDiv.innerHTML = `
                        <div class="option-label">${optionName}</div>
                        <div class="option-values">
                            ${values.map(value => `
                                <span class="option-value" data-option="${optionName}" data-value="${value}">${value}</span>
                            `).join('')}
                        </div>
                    `;
                    
                    productOptions.appendChild(optionDiv);
                    
                    // Set first value as selected by default
                    selectedOptions[optionName] = values[0];
                    
                    // Select the first option
                    const firstOption = optionDiv.querySelector('.option-value');
                    if (firstOption) {
                        firstOption.classList.add('selected');
                    }
                });
                
                // Add event listeners to option values
                document.querySelectorAll('.option-value').forEach(value => {
                    value.addEventListener('click', (e) => {
                        const optionName = e.target.dataset.option;
                        const optionValue = e.target.dataset.value;
                        
                        // Update selected options
                        selectedOptions[optionName] = optionValue;
                        
                        // Update UI
                        document.querySelectorAll(`.option-value[data-option="${optionName}"]`).forEach(v => {
                            v.classList.remove('selected');
                        });
                        e.target.classList.add('selected');
                    });
                });
            } else {
                productOptions.innerHTML = '<p>No options available</p>';
            }
            
            // Set delivery info if available
            if (currentShopData.deliveryEnabled) {
                deliveryInfo.style.display = 'block';
                deliveryDetails.textContent = currentShopData.deliveryDetails || 'Delivery available';
                
                // Show delivery price if available
                if (currentShopData.deliveryPrice) {
                    deliveryPrice.style.display = 'block';
                    deliveryPriceValue.textContent = `$${currentShopData.deliveryPrice.toFixed(2)}`;
                } else {
                    deliveryPrice.style.display = 'none';
                }
                
                // Show delivery time if available
                if (currentShopData.deliveryTime) {
                    deliveryTime.style.display = 'block';
                    deliveryTimeValue.textContent = currentShopData.deliveryTime;
                } else {
                    deliveryTime.style.display = 'none';
                }
                
                // Show delivery locations if available
                if (currentShopData.deliveryFrom && currentShopData.deliveryTo) {
                    deliveryFromTo.style.display = 'block';
                    deliveryFrom.textContent = currentShopData.deliveryFrom;
                    deliveryTo.textContent = currentShopData.deliveryTo;
                } else {
                    deliveryFromTo.style.display = 'none';
                }
            }
            
            // Show shop phone if enabled
            if (currentShopData.showPhone && currentShopData.phone) {
                shopPhone.style.display = 'block';
                shopPhoneNumber.textContent = currentShopData.phone;
                
                // Set WhatsApp button for shop owner
                whatsappBtn.style.display = 'inline-flex';
                const whatsappNumber = currentShopData.phone.replace(/\D/g, '');
                const message = `Hi, I'm interested in your product: ${product.name}%0A%0APrice: $${product.price.toFixed(2)}%0A%0APlease let me know how to proceed with the order.`;
                whatsappBtn.href = `https://wa.me/${whatsappNumber}?text=${message}`;
            } else {
                whatsappBtn.style.display = 'none';
            }
            
            // Show delivery phone if enabled
            if (currentShopData.deliveryEnabled && currentShopData.showDeliveryPhone && currentShopData.deliveryPhone) {
                deliveryPhone.style.display = 'block';
                deliveryPhoneNumber.textContent = currentShopData.deliveryPhone;
                
                // Set WhatsApp button for delivery
                whatsappDeliveryBtn.style.display = 'inline-flex';
                const whatsappNumber = currentShopData.deliveryPhone.replace(/\D/g, '');
                const message = `Hi, I have a question about delivery for product: ${product.name}%0A%0APrice: $${product.price.toFixed(2)}%0A%0APlease let me know about delivery options.`;
                whatsappDeliveryBtn.href = `https://wa.me/${whatsappNumber}?text=${message}`;
            } else {
                whatsappDeliveryBtn.style.display = 'none';
                deliveryPhone.style.display = 'none';
            }
            
            // Show modal
            productModal.show();
        }

        // Add to cart
        function addToCart() {
            if (!selectedProduct) return;
            
            // Create cart item
            const cartItem = {
                id: selectedProduct.id,
                productId: selectedProduct.id,
                name: selectedProduct.name,
                price: selectedProduct.price,
                image: selectedProduct.images ? selectedProduct.images[0] : 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22200%22%20height%3D%22200%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_18c3b7c4b1e%20text%20%7B%20fill%3A%23AAAAAA%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A10pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_18c3b7c4b1e%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2274.0859375%22%20y%3D%22104.5%22%3E200x200%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E',
                quantity: 1,
                options: selectedOptions
            };
            
            // Check if item already exists in cart
            const existingItemIndex = currentCart.findIndex(item => 
                item.productId === cartItem.productId && 
                JSON.stringify(item.options) === JSON.stringify(cartItem.options)
            );
            
            if (existingItemIndex >= 0) {
                // Update quantity
                currentCart[existingItemIndex].quantity += 1;
            } else {
                // Add new item
                currentCart.push(cartItem);
            }
            
            // Update cart in localStorage
            saveCart();
            
            // Update UI
            updateCartUI();
            
            // Show success message
            showToast('Product added to cart', 'success');
            
            // Close modal
            productModal.hide();
        }

        // Save cart to IndexedDB
        function saveCart() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ShopManagementDB', 2);
                
                request.onerror = function(event) {
                    reject("Database error: " + event.target.error);
                };
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    const transaction = db.transaction('carts', 'readwrite');
                    const store = transaction.objectStore('carts');
                    
                    const putRequest = store.put({
                        shopId: currentShopId,
                        items: currentCart
                    });
                    
                    putRequest.onerror = function(event) {
                        reject("Error saving cart: " + event.target.error);
                    };
                    
                    putRequest.onsuccess = function() {
                        resolve();
                    };
                };
            });
        }

        function loadCart() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ShopManagementDB', 2);
                
                request.onerror = function(event) {
                    reject("Database error: " + event.target.error);
                };
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    const transaction = db.transaction('carts', 'readonly');
                    const store = transaction.objectStore('carts');
                    
                    const getRequest = store.get(currentShopId);
                    
                    getRequest.onerror = function(event) {
                        reject("Error loading cart: " + event.target.error);
                    };
                    
                    getRequest.onsuccess = function() {
                        if (getRequest.result) {
                            currentCart = getRequest.result.items || [];
                            updateCartUI();
                        }
                        resolve();
                    };
                };
            });
        }

        // Update cart UI
        function updateCartUI() {
            // Update cart items list
            cartItems.innerHTML = '';
            
            if (currentCart.length === 0) {
                cartItems.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-shopping-cart fa-2x mb-2" style="opacity: 0.3;"></i>
                        <p>Your cart is empty</p>
                    </div>
                `;
                cartSummary.style.display = 'none';
            } else {
                let subtotal = 0;
                
                currentCart.forEach((item, index) => {
                    const cartItemElement = document.createElement('div');
                    cartItemElement.className = 'cart-item mb-3';
                    
                    // Calculate item total
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    
                    // Create options text
                    let optionsText = '';
                    if (item.options && Object.keys(item.options).length > 0) {
                        optionsText = Object.entries(item.options).map(([key, value]) => 
                            `${key}: ${value}`
                        ).join(', ');
                    }
                    
                    cartItemElement.innerHTML = `
                        <div class="d-flex gap-3">
                            <img src="${item.image}" class="cart-item-img" alt="${item.name}" loading="lazy">
                            <div class="flex-grow-1">
                                <h6>${item.name}</h6>
                                ${optionsText ? `<p class="cart-item-options">${optionsText}</p>` : ''}
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="quantity-selector">
                                        <button class="quantity-btn minus" data-index="${index}">-</button>
                                        <input type="number" class="quantity-input" value="${item.quantity}" min="1" data-index="${index}">
                                        <button class="quantity-btn plus" data-index="${index}">+</button>
                                    </div>
                                    <span class="fw-bold">$${itemTotal.toFixed(2)}</span>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-danger remove-item" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    cartItems.appendChild(cartItemElement);
                });
                
                // Update summary
                cartSubtotal.textContent = `$${subtotal.toFixed(2)}`;
                
                // Update delivery info if available
                if (currentShopData.deliveryEnabled) {
                    cartDeliveryInfo.style.display = 'block';
                    
                    // Set delivery price
                    if (currentShopData.deliveryPrice) {
                        cartDeliveryPrice.textContent = `$${currentShopData.deliveryPrice.toFixed(2)}`;
                    } else {
                        cartDeliveryPrice.textContent = 'Free';
                    }
                    
                    // Set delivery time
                    if (currentShopData.deliveryTime) {
                        cartDeliveryTime.textContent = currentShopData.deliveryTime;
                    } else {
                        cartDeliveryTime.textContent = 'Not specified';
                    }
                    
                    // Calculate total with delivery
                    const deliveryCost = currentShopData.deliveryPrice || 0;
                    const total = subtotal + deliveryCost;
                    cartTotal.textContent = `$${total.toFixed(2)}`;
                } else {
                    cartDeliveryInfo.style.display = 'none';
                    cartTotal.textContent = `$${subtotal.toFixed(2)}`;
                }
                
                // Update contact info if available
                if ((currentShopData.showPhone && currentShopData.phone) || 
                    (currentShopData.deliveryEnabled && currentShopData.showDeliveryPhone && currentShopData.deliveryPhone)) {
                    cartContactInfo.style.display = 'block';
                    
                    // Set shop phone if available
                    if (currentShopData.showPhone && currentShopData.phone) {
                        cartShopPhone.textContent = currentShopData.phone;
                        
                        // Set WhatsApp button for shop owner
                        const whatsappNumber = currentShopData.phone.replace(/\D/g, '');
                        
                        // Create cart items message
                        let cartItemsMessage = currentCart.map(item => {
                            let itemMessage = `${item.name} x${item.quantity} - $${(item.price * item.quantity).toFixed(2)}`;
                            
                            if (item.options && Object.keys(item.options).length > 0) {
                                itemMessage += ` (${Object.entries(item.options).map(([key, value]) => `${key}: ${value}`).join(', ')})`;
                            }
                            
                            return itemMessage;
                        }).join('%0A');
                        
                        // Add delivery info if available
                        if (currentShopData.deliveryEnabled) {
                            const deliveryCost = currentShopData.deliveryPrice || 0;
                            const total = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0) + deliveryCost;
                            
                            cartItemsMessage += `%0A%0ASubtotal: $${subtotal.toFixed(2)}`;
                            
                            if (deliveryCost > 0) {
                                cartItemsMessage += `%0ADelivery: $${deliveryCost.toFixed(2)}`;
                            }
                            
                            cartItemsMessage += `%0ATotal: $${total.toFixed(2)}`;
                            
                            if (currentShopData.deliveryTime) {
                                cartItemsMessage += `%0A%0ADelivery Time: ${currentShopData.deliveryTime}`;
                            }
                        }
                        
                        const message = `Hi, I would like to place an order:%0A%0A${cartItemsMessage}%0A%0APlease confirm my order.`;
                        whatsappCartBtn.href = `https://wa.me/${whatsappNumber}?text=${message}`;
                    } else {
                        cartShopPhone.textContent = 'Not available';
                        whatsappCartBtn.href = '#';
                    }
                    
                    // Set delivery phone if available
                    if (currentShopData.deliveryEnabled && currentShopData.showDeliveryPhone && currentShopData.deliveryPhone) {
                        cartDeliveryPhone.textContent = currentShopData.deliveryPhone;
                        
                        // Set WhatsApp button for delivery
                        const whatsappNumber = currentShopData.deliveryPhone.replace(/\D/g, '');
                        
                        // Create delivery message
                        let deliveryMessage = `Hi, I have a question about delivery for my order:%0A%0A`;
                        
                        deliveryMessage += currentCart.map(item => {
                            return `${item.name} x${item.quantity}`;
                        }).join('%0A');
                        
                        if (currentShopData.deliveryFrom && currentShopData.deliveryTo) {
                            deliveryMessage += `%0A%0ADelivery from ${currentShopData.deliveryFrom} to ${currentShopData.deliveryTo}`;
                        }
                        
                        whatsappDeliveryCartBtn.href = `https://wa.me/${whatsappNumber}?text=${deliveryMessage}`;
                    } else {
                        cartDeliveryPhone.textContent = 'Not available';
                        whatsappDeliveryCartBtn.href = '#';
                    }
                } else {
                    cartContactInfo.style.display = 'none';
                    whatsappCartBtn.href = '#';
                    whatsappDeliveryCartBtn.href = '#';
                }
                
                cartSummary.style.display = 'block';
                
                // Add event listeners to quantity buttons
                document.querySelectorAll('.quantity-btn.minus').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        updateCartItemQuantity(index, currentCart[index].quantity - 1);
                    });
                });
                
                document.querySelectorAll('.quantity-btn.plus').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        updateCartItemQuantity(index, currentCart[index].quantity + 1);
                    });
                });
                
                document.querySelectorAll('.quantity-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const newQuantity = parseInt(e.target.value) || 1;
                        updateCartItemQuantity(index, newQuantity);
                    });
                });
                
                document.querySelectorAll('.remove-item').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        removeCartItem(index);
                    });
                });
            }
            
            // Update cart badge
            const totalItems = currentCart.reduce((total, item) => total + item.quantity, 0);
            if (totalItems > 0) {
                cartBadge.textContent = totalItems;
                cartBadge.style.display = 'flex';
            } else {
                cartBadge.style.display = 'none';
            }
        }

        // Update cart item quantity
        function updateCartItemQuantity(index, newQuantity) {
            if (newQuantity < 1) newQuantity = 1;
            
            currentCart[index].quantity = newQuantity;
            saveCart();
            updateCartUI();
        }

        // Remove cart item
        function removeCartItem(index) {
            currentCart.splice(index, 1);
            saveCart();
            updateCartUI();
            showToast('Item removed from cart', 'info');
        }

        // Show toast message
        function showToast(message, type = 'info') {
           
            const toast = document.createElement('div');
            toast.className = `toast show align-items-center text-white bg-${type} border-0`;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '1100';

            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            document.body.appendChild(toast);

            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);

            // Close button
            toast.querySelector('.btn-close').addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Cart toggle
            cartNavBtn.addEventListener('click', (e) => {
                e.preventDefault();
                cartSidebar.classList.add('open');
                cartBackdrop.classList.add('open');
            });

            closeCartBtn.addEventListener('click', () => {
                cartSidebar.classList.remove('open');
                cartBackdrop.classList.remove('open');
            });

            cartBackdrop.addEventListener('click', () => {
                cartSidebar.classList.remove('open');
                cartBackdrop.classList.remove('open');
            });

            // Product modal
            addToCartBtn.addEventListener('click', (e) => {
                e.preventDefault();
                addToCart();
            });

            // Search and filter
            searchInput.addEventListener('input', () => {
                searchTerm = searchInput.value.trim().toLowerCase();

                if (searchTerm) {
                    // Filter current products
                    filteredProducts = currentProducts.filter(product =>
                        product.name.toLowerCase().includes(searchTerm) ||
                        (product.description && product.description.toLowerCase().includes(searchTerm))
                    );

                    // Display filtered products
                    displayProducts(filteredProducts);

                    // Show no products message if empty
                    if (filteredProducts.length === 0) {
                        noProducts.style.display = 'block';
                        productsGrid.style.display = 'grid';
                        productsGrid.innerHTML = '';
                    } else {
                        noProducts.style.display = 'none';
                        productsGrid.style.display = 'grid';
                    }
                } else {
                    // Show all products if search is empty
                    displayProducts(currentProducts);
                    noProducts.style.display = 'none';
                }
            });

            // Infinite scroll for products
            window.addEventListener('scroll', () => {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                    if (searchTerm) {
                        // Don't load more when searching
                        return;
                    }
                    loadProducts(true);
                }
            });
        }
    </script>
</body>
</html>
